- name: Deploy Polymetrie Application
  hosts: localhost
  gather_facts: false
  become: yes
  vars:
    ansible_python_interpreter: /usr/bin/python3

  tasks:
    - name: Install Helm Chart for Redis
      kubernetes.core.helm:
        name: redis
        chart_ref: bitnami/redis
        release_namespace: default
        create_namespace: true

    - name: Wait for Redis deployment to finish (adjust sleep time as needed)
      pause:
        seconds: 10

    - name: Set Redis Password as Environment Variable
      kubernetes.core.k8s:
        state: present
        definition:
          apiVersion: v1
          kind: ConfigMap
          metadata:
            name: redis-config
            namespace: default
          data:
            REDIS_PASSWORD: "{{ lookup('pipe', 'kubectl get secret --namespace default redis -o jsonpath={.data.redis-password} | base64 --decode') }}"
            
    - name: Install Helm Chart for PostgreSQL
      kubernetes.core.helm:
        name: postgresql
        chart_ref: bitnami/postgresql
        release_namespace: default
        create_namespace: true
        values:
          postgresqlPassword: "cBxkAqQtZR"

    - name: Apply Kubernetes YAML files
      kubernetes.core.k8s:
        state: present
        definition: "{{ lookup('file', item) }}"
      with_items:
        - polymetrie-deployment.yaml
        - polymetrie-service.yaml
        - polymetrie-ingress.yaml
